# Web サービス「Sweet Sprouts」API 概念設計書

## 1. 概要

本ドキュメントは、Sweet Sprouts のバックエンドが提供する API の概念設計を定義します。API は RESTful な原則に基づき、フロントエンドアプリケーションからのリクエストに応じて、ユーザー認証、お子さん情報の管理、および各種育児記録（授乳、排泄）の登録・取得・更新・削除機能を提供します。API の設計は、明確なエンドポイント、適切な HTTP メソッド、セキュアな認証認可、そしてデータの一貫性を重視します。

※OpenAPI 仕様 (`api_specification.yaml`) が詳細な技術仕様を記述するのに対し、この概念設計書は API の**「何を」「どのように」提供するか**という高レベルな設計思想を説明します。

## 2. API の基本原則

Sweet Sprouts の API は、以下の原則に基づいて設計されます。

- **RESTful 原則**: リソース指向の設計を採用し、統一されたインターフェース（URI、HTTP メソッド）を通じてリソースを操作します。
- **ステートレス**: 各リクエストは独立しており、サーバーはクライアントのセッション状態を保持しません。認証は JWT トークンによって行われます。
- **型安全性**: TypeScript と Zod、Prisma ORM を活用し、API リクエスト・レスポンスのスキーマとデータベースモデル間で厳密な型チェックを行い、データの一貫性と堅牢性を確保します。
- **セキュア**: 全ての通信は HTTPS で行われ、認証（JWT）と認可（ロールベースアクセス制御）によって API へのアクセスが保護されます。
- **予測可能性**: エラーレスポンスは一貫した形式で提供され、クライアント側でのハンドリングを容易にします。

## 3. API エンドポイントの構成

主要なリソース（User, Child, Record）ごとにエンドポイントを定義します。

### 3.1. 認証・認可関連 API

ユーザーの認証とセッション管理を行います。

- **`POST /auth/register`**
  - **機能**: 新規ユーザー登録。**メールアドレス、パスワード、およびユーザー名を受け取り**、データベースに新しいユーザーアカウントを作成します。成功時には、認証済みのセッション情報（アクセストークンとリフレッシュトークン、ユーザー情報）が返されます。
  - **認証**: 不要
  - **認可**: 誰でも登録可能
- **`POST /auth/login`**
  - **機能**: ユーザーログイン。メールアドレスとパスワードを受け取り、認証に成功した場合に JWT トークン（アクセストークンとリフレッシュトークン）を発行します。
  - **認証**: 不要
  - **認可**: 誰でもログイン可能
- **`POST /auth/session`**
  - **機能**: 認証状態を最新に更新。有効期限切れのアクセストークンを、リフレッシュトークンを使用して新しいものに更新し、同時に最新のユーザー情報を取得します。これにより、ユーザーは再ログインの手間なくサービスを継続利用できます。
  - **認証**: 不要 (リフレッシュトークンによる認証)
  - **認可**: 有効なリフレッシュトークンを持つユーザー

### 3.2. ユーザー関連 API

ユーザー自身の情報を管理します。

- **`GET /users/{userId}`**
  - **機能**: 特定のユーザー情報を取得します。
  - **認証**: 必要 (アクセストークン)
  - **認可**: ADMIN ロール、または自身の ID (`userId`) と一致する場合
- **`PUT /users/{userId}`**
  - **機能**: 特定のユーザー情報を更新します。パスワードやロールの変更を含む。
  - **認証**: 必要 (アクセストークン)
  - **認可**: ADMIN ロール、または自身の ID (`userId`) と一致する場合
- **`DELETE /users/{userId}`**
  - **機能**: 特定のユーザーを削除します。
  - **認証**: 必要 (アクセストークン)
  - **認可**: ADMIN ロール、または自身の ID (`userId`) と一致する場合

### 3.3. お子さん関連 API

複数のお子さん情報の CRUD（作成、読み取り、更新、削除）を行います。各お子さんは登録ユーザーに紐づきます。

- **`POST /children`**
  - **機能**: 新しいお子さん情報を登録します。
  - **認証**: 必要 (アクセストークン)
  - **認可**: `GUARDIAN` ロールのみ
- **`GET /children`**
  - **機能**: ログインユーザーが登録した全てのお子さん情報を取得します。
  - **認証**: 必要 (アクセストークン)
  - **認可**: 全ての認証済みユーザー（自身の登録したお子さんのみ取得可能）
- **`GET /children/{childId}`**
  - **機能**: 特定のお子さん情報を取得します。
  - **認証**: 必要 (アクセストークン)
  - **認可**: 当該お子さんを登録したユーザー (`GUARDIAN`)、または閲覧権限を持つユーザー (`VIEWER`)、または `ADMIN` ロール
- **`PUT /children/{childId}`**
  - **機能**: 特定のお子さん情報を更新します。
  - **認証**: 必要 (アクセストークン)
  - **認可**: 当該お子さんを登録したユーザー (`GUARDIAN`)、または `ADMIN` ロール
- **`DELETE /children/{childId}`**
  - **機能**: 特定のお子さん情報を削除します。
  - **認証**: 必要 (アクセストークン)
  - **認可**: 当該お子さんを登録したユーザー (`GUARDIAN`)、または `ADMIN` ロール

### 3.4. 記録関連 API

授乳記録、排泄記録などの育児記録の CRUD を行います。各記録は特定のお子さんに紐づきます。

- **`POST /records`**
  - **機能**: 新しい育児記録（授乳または排泄）を登録します。リクエストボディの `type` フィールドにより、詳細な情報（`feedingDetails` または `diaperDetails`）が分岐します。
  - **授乳記録**: **`time` (開始時刻)** と **`endTime` (終了時刻)** を必須とし、`feedingMethod`（直接授乳、搾乳、ミルク）、`breastSide`（左右）、`amountMl`（量）を含めます。
  - **排泄記録**: `time` を必須とし、`diaperType`（うんち、おしっこ）、`poopConsistency`（うんちの状態）を含めます。
  - **認証**: 必要 (アクセストークン)
  - **認可**: 当該お子さんを登録したユーザー (`GUARDIAN`)、または `ADMIN` ロール
- **`GET /records`**
  - **機能**: 特定の条件（例: `childId`、期間、記録タイプ）に基づいて記録の一覧を取得します。タイムライン表示のために利用されます。
  - **認証**: 必要 (アクセストークン)
  - **認可**: 当該お子さんを登録したユーザー (`GUARDIAN`)、または閲覧権限を持つユーザー (`VIEWER`)、または `ADMIN` ロール
- **`GET /records/{recordId}`**
  - **機能**: 特定の記録の詳細情報を取得します。
  - **認証**: 必要 (アクセストークン)
  - **認可**: 当該記録が紐づくお子さんを登録したユーザー (`GUARDIAN`)、または閲覧権限を持つユーザー (`VIEWER`)、または `ADMIN` ロール
- **`PUT /records/{recordId}`**
  - **機能**: 特定の記録を更新します。記録タイプに応じた詳細情報も更新可能です。
  - **認証**: 必要 (アクセストークン)
  - **認可**: 当該記録が紐づくお子さんを登録したユーザー (`GUARDIAN`)、または `ADMIN` ロール
- **`DELETE /records/{recordId}`**
  - **機能**: 特定の記録を削除します。関連する詳細情報（授乳、排泄）も同時に削除されます。
  - **認証**: 必要 (アクセストークン)
  - **認可**: 当該記録が紐づくお子さんを登録したユーザー (`GUARDIAN`)、または `ADMIN` ロール

## 4. リクエストとレスポンスの形式

- **データ形式**: 全てのリクエストボディとレスポンスボディは **JSON 形式** とします。
- **タイムスタンプ**: 日付と時刻は **ISO 8601 形式 (`YYYY-MM-DDTHH:MM:SSZ`)** で統一します。
- **ユニーク ID**: エンティティの識別子には **UUID** を使用します。
- **成功時のレスポンス**:
  - データ取得 (`GET`): `200 OK` とレスポンスボディにデータ。
  - データ作成 (`POST`): `201 Created` とレスポンスボディに作成されたデータ、または成功メッセージ。
  - データ更新 (`PUT`): `200 OK` とレスポンスボディに更新されたデータ、または成功メッセージ。
  - データ削除 (`DELETE`): `204 No Content` または `200 OK` と成功メッセージ。
- **エラー時のレスポンス**:
  - エラーは一貫した JSON 形式で返却します。例: `{ "statusCode": 400, "message": "Invalid input data", "details": [...] }`
  - 一般的な HTTP ステータスコードを使用します。
    - `400 Bad Request`: リクエストボディの形式不正、バリデーションエラーなど。
    - `401 Unauthorized`: 認証トークンがない、または無効。
    - `403 Forbidden`: 認証済みだが、リソースへのアクセス権限がない。
    - `404 Not Found`: 指定されたリソースが見つからない。
    - `409 Conflict`: リソースの競合 (例: 既に登録済みのメールアドレス)。
    - `500 Internal Server Error`: サーバー内部エラー。

## 5. バリデーション

- **フロントエンドバリデーション**: ユーザー入力の初期チェックとしてクライアント側でも Zod によるバリデーションを実施し、即時フィードバックを提供し、無駄な API リクエストを防ぎます。
- **バックエンドバリデーション**: 全ての API エンドポイントで、Zod スキーマに基づいた厳格なバリデーションを実施します。これにより、不正なデータや不足しているデータがデータベースに保存されるのを防ぎます。授乳記録の `endTime` が `time` (開始時刻) より後であることなども、この層で厳密にチェックされます。

## 6. 認証と認可

- **認証**: JWT (JSON Web Tokens) を使用したトークンベース認証を導入します。ログイン時に発行されるアクセストークンを、以降の全ての保護された API リクエストの HTTP ヘッダー (`Authorization: Bearer <token>`) に含めます。
- **認可**: ユーザーの `role` (ADMIN, GUARDIAN, VIEWER) に基づくロールベースアクセス制御 (RBAC) を実装します。各 API エンドポイントは、アクセスするユーザーのロールをチェックし、適切な権限がある場合のみ操作を許可します。
- サーバー負荷を考慮したトークン管理:
  - ユーザーがログインに成功すると、有効期限の短いアクセストークンと、有効期限の長いリフレッシュトークンの両方が発行されます。
  - クライアントは、API リクエストの際にアクセストークンを使用し、その有効期限が切れるまでリフレッシュトークンは使用しません。
  - アクセストークンの有効期限が切れた場合、クライアントは**POST /auth/session**エンドポイントを呼び出し、保存しておいたリフレッシュトークンを使って新しいアクセストークンとリフレッシュトークンを再発行します。
  - この方式により、画面リロードや再アクセスごとにトークンを再発行するのではなく、アクセストークンの有効期限が切れた時のみ再発行リクエストが発生するため、サーバーへの負荷を軽減します。

---
